---
export const prerender = true;

import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import MasonryGrid from '../components/MasonryGrid.astro';

// Fetch overview content
const allOverview = await getCollection('overview');

// Sort by order (if specified) then by date
const sortedOverview = allOverview.sort((a, b) => {
  if (a.data.order !== b.data.order) {
    return a.data.order - b.data.order;
  }
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Map to image format expected by MasonryGrid
const images = sortedOverview.map((item) => ({
  id: item.id,
  src: item.data.image,
  thumbnail: item.data.thumbnail,
  alt: item.data.title,
  width: item.data.width,
  height: item.data.height,
  date: item.data.date
}));

// Fallback to sample images if no content uploaded yet
const sampleImages = [
  { id: '1', src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=1200&fit=crop', alt: 'Mountain landscape', width: 800, height: 1200 },
  { id: '2', src: 'https://images.unsplash.com/photo-1682687221038-404cb8830901?w=800&h=600&fit=crop', alt: 'Coastal view', width: 800, height: 600 },
  { id: '3', src: 'https://images.unsplash.com/photo-1682687220923-c58b9a4592ae?w=800&h=1000&fit=crop', alt: 'Forest path', width: 800, height: 1000 },
  { id: '4', src: 'https://images.unsplash.com/photo-1682687220063-4742bd7fd538?w=800&h=800&fit=crop', alt: 'Desert dunes', width: 800, height: 800 },
  { id: '5', src: 'https://images.unsplash.com/photo-1682687218147-9806132dc697?w=800&h=1200&fit=crop', alt: 'City skyline', width: 800, height: 1200 },
  { id: '6', src: 'https://images.unsplash.com/photo-1682687220199-d0124f48f95b?w=800&h=600&fit=crop', alt: 'Waterfall', width: 800, height: 600 },
  { id: '7', src: 'https://images.unsplash.com/photo-1682687218608-5e2522b04673?w=800&h=900&fit=crop', alt: 'Snow peaks', width: 800, height: 900 },
  { id: '8', src: 'https://images.unsplash.com/photo-1682687218001-a33fc699c1f2?w=800&h=1100&fit=crop', alt: 'Ocean waves', width: 800, height: 1100 },
  { id: '9', src: 'https://images.unsplash.com/photo-1682687220211-c471118c9e92?w=800&h=700&fit=crop', alt: 'Sunset colors', width: 800, height: 700 },
  { id: '10', src: 'https://images.unsplash.com/photo-1682687220795-796d3f6f7000?w=800&h=1000&fit=crop', alt: 'Wildlife', width: 800, height: 1000 },
  { id: '11', src: 'https://images.unsplash.com/photo-1682687221175-fd40bbafe6ce?w=800&h=600&fit=crop', alt: 'Architecture', width: 800, height: 600 },
  { id: '12', src: 'https://images.unsplash.com/photo-1682687220866-c856f566f1bd?w=800&h=950&fit=crop', alt: 'Street scene', width: 800, height: 950 },
  { id: '13', src: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=800&h=1200&fit=crop', alt: 'Nature scene', width: 800, height: 1200 },
  { id: '14', src: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=800&h=650&fit=crop', alt: 'Sunset', width: 800, height: 650 },
  { id: '15', src: 'https://images.unsplash.com/photo-1426604966848-d7adac402bff?w=800&h=1100&fit=crop', alt: 'Forest', width: 800, height: 1100 },
  { id: '16', src: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=800&h=800&fit=crop', alt: 'Valley', width: 800, height: 800 },
  { id: '17', src: 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=800&h=900&fit=crop', alt: 'Misty hills', width: 800, height: 900 },
  { id: '18', src: 'https://images.unsplash.com/photo-1470770903676-69b98201ea1c?w=800&h=1200&fit=crop', alt: 'Beach', width: 800, height: 1200 },
  { id: '19', src: 'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=800&h=600&fit=crop', alt: 'Tropical', width: 800, height: 600 },
  { id: '20', src: 'https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?w=800&h=1000&fit=crop', alt: 'Flower field', width: 800, height: 1000 },
  { id: '21', src: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&h=1100&fit=crop', alt: 'Woods', width: 800, height: 1100 },
  { id: '22', src: 'https://images.unsplash.com/photo-1465146633011-14f8e0781093?w=800&h=700&fit=crop', alt: 'Countryside', width: 800, height: 700 },
  { id: '23', src: 'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&h=950&fit=crop', alt: 'Lake view', width: 800, height: 950 },
  { id: '24', src: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=800&h=800&fit=crop', alt: 'Golden hour', width: 800, height: 800 },
  { id: '25', src: 'https://images.unsplash.com/photo-1500375592092-40eb2168fd21?w=800&h=1200&fit=crop', alt: 'Northern lights', width: 800, height: 1200 },
  { id: '26', src: 'https://images.unsplash.com/photo-1418065460487-3e41a6c84dc5?w=800&h=600&fit=crop', alt: 'Cliff edge', width: 800, height: 600 },
  { id: '27', src: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800&h=1000&fit=crop', alt: 'Snow mountain', width: 800, height: 1000 },
  { id: '28', src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=900&fit=crop', alt: 'Alpine peak', width: 800, height: 900 },
  { id: '29', src: 'https://images.unsplash.com/photo-1454496522488-7a8e488e8606?w=800&h=1100&fit=crop', alt: 'Canyon', width: 800, height: 1100 },
  { id: '30', src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=700&fit=crop', alt: 'Desert road', width: 800, height: 700 },
  { id: '31', src: 'https://images.unsplash.com/photo-1511593358241-7eea1f3c84e5?w=800&h=950&fit=crop', alt: 'Urban landscape', width: 800, height: 950 },
  { id: '32', src: 'https://images.unsplash.com/photo-1449034446853-66c86144b0ad?w=800&h=800&fit=crop', alt: 'City lights', width: 800, height: 800 },
  { id: '33', src: 'https://images.unsplash.com/photo-1519046904884-53103b34b206?w=800&h=1200&fit=crop', alt: 'Sandy beach', width: 800, height: 1200 },
  { id: '34', src: 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=800&h=600&fit=crop', alt: 'Rocky shore', width: 800, height: 600 },
  { id: '35', src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=1000&fit=crop', alt: 'Mountain path', width: 800, height: 1000 },
  { id: '36', src: 'https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?w=800&h=1100&fit=crop', alt: 'River valley', width: 800, height: 1100 },
  { id: '37', src: 'https://images.unsplash.com/photo-1490730141103-6cac27aaab94?w=800&h=700&fit=crop', alt: 'Open field', width: 800, height: 700 },
  { id: '38', src: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=800&h=950&fit=crop', alt: 'Rolling hills', width: 800, height: 950 },
  { id: '39', src: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=800&h=800&fit=crop', alt: 'Starry night', width: 800, height: 800 },
  { id: '40', src: 'https://images.unsplash.com/photo-1505144808419-1957a94ca61e?w=800&h=1200&fit=crop', alt: 'Palm trees', width: 800, height: 1200 },
  { id: '41', src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop', alt: 'Glacier', width: 800, height: 600 },
  { id: '42', src: 'https://images.unsplash.com/photo-1478860409698-8707f313ee8b?w=800&h=1000&fit=crop', alt: 'Autumn forest', width: 800, height: 1000 },
  { id: '43', src: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=800&h=900&fit=crop', alt: 'Highland', width: 800, height: 900 },
  { id: '44', src: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&h=1100&fit=crop', alt: 'Ocean sunset', width: 800, height: 1100 },
  { id: '45', src: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?w=800&h=700&fit=crop', alt: 'Seascape', width: 800, height: 700 },
  { id: '46', src: 'https://images.unsplash.com/photo-1484406566174-9da000fda645?w=800&h=950&fit=crop', alt: 'Winter scene', width: 800, height: 950 },
  { id: '47', src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=800&fit=crop', alt: 'Summit view', width: 800, height: 800 },
  { id: '48', src: 'https://images.unsplash.com/photo-1502740479091-635887520276?w=800&h=1200&fit=crop', alt: 'Tree silhouette', width: 800, height: 1200 },
  { id: '49', src: 'https://images.unsplash.com/photo-1486870591958-9b9d0d1dda99?w=800&h=600&fit=crop', alt: 'Meadow', width: 800, height: 600 },
  { id: '50', src: 'https://images.unsplash.com/photo-1508817628294-5a453fa0b8fb?w=800&h=1000&fit=crop', alt: 'Cave entrance', width: 800, height: 1000 },
  { id: '51', src: 'https://images.unsplash.com/photo-1493246507139-91e8fad9978e?w=800&h=1100&fit=crop', alt: 'Jungle path', width: 800, height: 1100 },
  { id: '52', src: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=800&h=850&fit=crop', alt: 'Evening sky', width: 800, height: 850 },
];

// Use uploaded content if available, otherwise show sample images
const displayImages = images.length > 0 ? images : sampleImages;
---

<BaseLayout title="AndrÃ© Branco - Photography">
  <Header />

  <!-- Gallery Section - starts right away -->
  <section class="min-h-screen pt-8 pb-20">
    <div class="container mx-auto px-3 md:px-4 max-w-[1920px]">
      <MasonryGrid images={displayImages} />
    </div>
  </section>
</BaseLayout>

<script>
  import { openGallery } from '../scripts/gallery';

  // Small helper: extract image data from DOM
  const getImageData = (item: Element) => {
    const img = item.querySelector('img');
    const fullSrc = (item as HTMLElement).dataset.fullSrc;
    return {
      src: fullSrc || img?.src || '',
      alt: img?.alt || ''
    };
  };

  // Small helper: bind clicks to items
  const bindClicks = (items: Element[], images: { src: string; alt: string }[]) => {
    items.forEach((item, index) => {
      item.addEventListener('click', () => {
        openGallery(images, index);
      });
    });
  };

  // Initialize: setup gallery clicks
  const init = () => {
    const items = Array.from(document.querySelectorAll('.masonry-item'));
    const images = items.map(getImageData);
    bindClicks(items, images);

    // Check for photo parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const photoParam = urlParams.get('photo');
    if (photoParam) {
      const photoIndex = parseInt(photoParam, 10) - 1;
      if (photoIndex >= 0 && photoIndex < images.length) {
        openGallery(images, photoIndex);
      }
    }
  };

  // Run on load
  init();
</script>
